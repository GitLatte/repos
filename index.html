<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CloudStream Eklenti Listesi</title>
    <style>
        body { 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    background-color: #f5f5f5; 
    text-align: center; 
}
h2 { color: #333; }

.stats { 
    font-size: 18px; 
    font-weight: bold; 
    margin-bottom: 10px; 
}

.filter-container { margin-bottom: 10px; }
select, input { 
    padding: 6px; 
    font-size: 14px; 
    border-radius: 4px; 
    border: 1px solid #ccc; 
    margin: 4px; 
}
button { 
    padding: 6px; 
    font-size: 14px; 
    border-radius: 4px; 
    background: #007BFF; 
    color: white; 
    border: none; 
    cursor: pointer; 
    transition: 0.3s ease; 
}
button:hover { background: #0056b3; }

/* Tablo için şık ve modern tasarım */
table { 
    width: 95%; 
    border-collapse: separate; 
    border-spacing: 0; 
    margin: auto; 
    background: white; 
    border-radius: 10px; 
    overflow: hidden; 
    border: 2px solid #007BFF; /* Tablo kenarlığını belirginleştirdik */
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1); /* Hafif gölge ekledik */
}

th, td { 
    border: 1px solid #ccc; 
    padding: 10px; 
    text-align: left; 
    font-size: 14px; 
}
th { 
    background-color: #007BFF; 
    color: white; 
    font-size: 15px; 
    border-bottom: 2px solid #0056b3; /* Daha belirgin alt kenar */
}
tr:hover { 
    background-color: #f9f9f9; /* Hover efekti biraz daha yumuşak */
    transition: 0.2s ease-in-out;
}

.bold { font-weight: bold; }
.desc { font-size: 12px; color: #555; }

/* Depo kodları için renkli badge */
.repo-badge {
    display: inline-block;
    font-size: 12px;
    padding: 5px 8px;
    border-radius: 6px;
    margin-right: 4px;
    color: white;
    font-weight: bold;
    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2); /* Hafif gölge */
}

/* Her repo için özel renkler */
.repo-sinetech { background-color: #FF5733; }  /* Turuncu */
.repo-nikstream { background-color: #33B5E5; } /* Mavi */
.repo-feroxxcs3 { background-color: #FF9800; } /* Açık Turuncu */
.repo-makoto { background-color: #4CAF50; }  /* Yeşil */
.repo-kekikdevam { background-color: #673AB7; } /* Mor */
.repo-kekikan { background-color: #E91E63; } /* Pembe */
.repo-sarapcanagii { background-color: #607D8B; } /* Gri */

/* Ana başlığı şık hale getirme */
.header-title {
    font-size: 28px;
    font-weight: bold;
    color: #007BFF;
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.15);
}

/* İstatistikler için özel kart tasarımı */
.stats-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
}

.stats-card {
    background-color: #ffffff;
    padding: 12px 20px;
    border-radius: 8px;
    border: 2px solid #007BFF;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    font-size: 16px;
    font-weight: bold;
    color: #333;
    min-width: 240px;
    text-align: center;
    transition: 0.3s ease-in-out;
}

.stats-card:hover {
    background-color: #007BFF;
    color: white;
    transform: scale(1.05);
}

    </style>    
</head>
<body>
    <h2 class="header-title">CS TR Eklenti ve Depo Listesi</h2>

    <div class="stats-container">
        <div class="stats-card"><span id="totalPlugins">Toplam Eklenti: 0</span></div>
        <div class="stats-card"><span id="totalRepos">Toplam Depo: 0</span></div>
        <div class="stats-card"><span id="lastUpdated">Son Güncelleme: Bilinmiyor</span></div>
    </div>  

    <div class="filter-container">
        <label for="filterSelect">Medya Türü Seç:</label>
        <select id="filterSelect">
            <option value="all">Tüm Eklentiler</option>
        </select>

        <label for="repoFilterSelect">Depo Seç:</label>
        <select id="repoFilterSelect">
            <option value="all">Tüm Depolar</option>
        </select>
    </div>

    <div class="filter-container">
        <input type="text" id="searchInput" placeholder="Eklenti Ara...">
        <button id="clearSearch">Temizle</button>
    </div>

    <table id="pluginTable">
        <thead>
            <tr>
                <th>İkon</th>
                <th>Ad</th>
                <th>Depo Kodu</th>
                <th>Tür</th>
                <th>Açıklama</th>
                <th>Dil</th>
                <th>Ver.</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>

function fetchPlugins() {
        fetch("https://GitLatte.github.io/repos/data.json")
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP hatası: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Çekilen Veri:", data); // Hata ayıklama için burayı kontrol edin

            let pluginList = null;
            let lastUpdatedTimestamp = null;

            // 1. Senaryo: Veri { "timestamp": ..., "plugins": [...] } formatında bir obje
            if (data && Array.isArray(data.plugins)) {
                pluginList = data.plugins;
                lastUpdatedTimestamp = data.timestamp;
                console.log("Veri obje formatında algılandı.");

            // 2. Senaryo: Veri doğrudan bir dizi [...] formatında
            } else if (Array.isArray(data)) {
                pluginList = data;
                // Bu senaryoda timestamp bilgisi doğrudan JSON'da yok,
                // bu nedenle 'Bilinmiyor' olarak kalabilir veya farklı bir varsayılan atanabilir.
                 lastUpdatedTimestamp = null; // Veya data.timestamp varsa al (pek olası değil bu senaryoda)
                console.log("Veri dizi formatında algılandı.");

            } else {
                 // Beklenmeyen format
                 console.error("Hata: Çekilen veri beklenen formatta değil.", data);
                 // Hata durumunda tabloyu ve istatistikleri temizle
                 document.getElementById("totalPlugins").textContent = "Veri yüklenemedi.";
                 document.getElementById("totalRepos").textContent = "";
                 document.getElementById("lastUpdated").textContent = "Son Güncelleme: Hata";
                 document.getElementById("filterSelect").innerHTML = '<option value="all">Veri Yok</option>';
                 document.getElementById("repoFilterSelect").innerHTML = '<option value="all">Veri Yok</option>';
                 document.querySelector("#pluginTable tbody").innerHTML = '<tr><td colspan="7">Eklenti verisi yüklenemedi veya formatı yanlış.</td></tr>';
                 window.pluginData = { plugins: [], timestamp: null }; // Hata durumunda pluginData'yı boş dizi olarak ayarla
                 return; // İşlemi durdur
            }

            // pluginList başarıyla belirlendiğinde devam et
            if (pluginList !== null) {
                window.pluginData = { // window.pluginData'yı tutarlı bir obje formatında sakla
                    plugins: pluginList,
                    timestamp: lastUpdatedTimestamp
                };

                updateStats("all");       // window.pluginData.plugins kullanacak
                updateFilterOptions();    // window.pluginData.plugins kullanacak
                updateRepoOptions();      // window.pluginData.plugins kullanacak
                updateTable("all", "all", ""); // window.pluginData.plugins kullanacak
                updateLastUpdated();      // window.pluginData.timestamp kullanacak

            } // else durumu yukarıdaki hata bloğunda ele alınıyor

        })
        .catch(error => {
            console.error("JSON verisi yüklenemedi:", error);
            // Hata durumunda tabloyu ve istatistikleri temizle
            document.getElementById("totalPlugins").textContent = "Veri yüklenemedi.";
            document.getElementById("totalRepos").textContent = "";
            document.getElementById("lastUpdated").textContent = "Son Güncelleme: Hata";
            document.getElementById("filterSelect").innerHTML = '<option value="all">Veri Yok</option>';
            document.getElementById("repoFilterSelect").innerHTML = '<option value="all">Veri Yok</option>';
            document.querySelector("#pluginTable tbody").innerHTML = '<tr><td colspan="7">Eklenti verisi yüklenemedi veya formatı yanlış.</td></tr>';
             window.pluginData = { plugins: [], timestamp: null }; // Hata durumunda pluginData'yı boş dizi olarak ayarla
        });
         }

         function updateLastUpdated() {
    const lastUpdatedElement = document.getElementById("lastUpdated");
    // window.pluginData artık tüm objeyi tutuyor, timestamp ona ait
    if (!window.pluginData || !window.pluginData.timestamp) {
        lastUpdatedElement.textContent = "Son Güncelleme: Bilinmiyor";
        return;
    }

    const lastUpdatedTime = new Date(window.pluginData.timestamp);
    const currentTime = new Date();
    const timeDifference = Math.floor((currentTime - lastUpdatedTime) / (1000 * 60)); // Dakika hesaplama

    let displayText = "";
    if (timeDifference < 1) {
        displayText = "Az önce güncellendi"; // Daha kısa ifade
    } else if (timeDifference < 60) {
        displayText = `${timeDifference} dakika önce`; // Daha kısa ifade
    } else {
        const hours = Math.floor(timeDifference / 60);
        const minutes = timeDifference % 60;
        // Saat ve dakika olarak gösterme
         if (minutes === 0) {
             displayText = `${hours} saat önce`;
         } else {
             displayText = `${hours} saat ${minutes} dakika önce`;
         }
    }

    lastUpdatedElement.textContent = `Son Güncelleme: ${displayText}`;
}

         function updateStats(selectedRepo = "all") {
    // Veriye artık window.pluginData.plugins üzerinden erişiyoruz
    if (!window.pluginData || !Array.isArray(window.pluginData.plugins)) return; // Eğer veri yoksa, hata verme!

    const totalPlugins = window.pluginData.plugins.length;
    // Hata düzeltildi: window.pluginData.plugins.map çağrılıyor
    // Ayrıca repositoryUrl yerine repoCodes listesindeki her bir kodu alıp birleştirmek gerekiyor
    let allRepoCodes = new Set();
    window.pluginData.plugins.forEach(plugin => {
        if (plugin.repoCodes && Array.isArray(plugin.repoCodes)) {
            plugin.repoCodes.forEach(code => allRepoCodes.add(code));
        }
    });
    const totalRepos = allRepoCodes.size;

    let selectedRepoCount = 0;
    let selectedRepoDisplay = "Bilinmiyor";

    if (selectedRepo !== "all") {
        const selectedPlugins = window.pluginData.plugins.filter(plugin => plugin.repoCodes && plugin.repoCodes.includes(selectedRepo));
        selectedRepoCount = selectedPlugins.length;
        // İstatistik kartında sadece repo kodunu gösterelim
        selectedRepoDisplay = selectedRepo; // selectedRepoName artık kullanılmıyor burada
    }

    // HTML'de stats-card divleri ayrı olduğu için içlerini ayrı ayrı güncelleyelim
    document.getElementById("totalPlugins").textContent = selectedRepo === "all" ? `Toplam Eklenti: ${totalPlugins}` : `Eklenti Sayısı: ${selectedRepoCount}`;
    document.getElementById("totalRepos").textContent = selectedRepo === "all" ? `Toplam Depo: ${totalRepos}` : `Depo Kodu: ${selectedRepoDisplay}`;
    // Son güncelleme tarihi bu fonksiyonda değil, updateLastUpdated'da güncelleniyor
}




function updateFilterOptions() {
    // Veriye artık window.pluginData.plugins üzerinden erişiyoruz
    if (!window.pluginData || !Array.isArray(window.pluginData.plugins)) return; // Eğer veri yoksa hata vermeyi önle!

    const filterSelect = document.getElementById("filterSelect");
    filterSelect.innerHTML = '<option value="all">Tüm Eklentiler</option>'; // Varsayılan seçenek

    let mediaTypes = new Set();
    // Hata düzeltildi: window.pluginData.plugins.forEach çağrılıyor
    window.pluginData.plugins.forEach(plugin => {
        if (plugin.tvTypes && Array.isArray(plugin.tvTypes)) {
            plugin.tvTypes.forEach(type => mediaTypes.add(type));
        }
    });

    mediaTypes.forEach(type => {
        let option = document.createElement("option");
        option.value = type;
        option.textContent = type;
        filterSelect.appendChild(option);
    });
}


        function updateRepoOptions() {
    // Veriye artık window.pluginData.plugins üzerinden erişiyoruz
    if (!window.pluginData || !Array.isArray(window.pluginData.plugins)) return; // Eğer veri yoksa hata vermeyi önle!

    const repoFilterSelect = document.getElementById("repoFilterSelect");
    let repositories = new Set();
    let repoNames = new Map();

    // Hata düzeltildi: window.pluginData.plugins.forEach çağrılıyor
    window.pluginData.plugins.forEach(plugin => {
        if (plugin.repoCodes && Array.isArray(plugin.repoCodes)) {
            plugin.repoCodes.forEach(repo => {
                repositories.add(repo);
                repoNames.set(repo, repo === "sinetech" ? "Latte / sinetech" : repo);
            });
        }
    });

    repoFilterSelect.innerHTML = '<option value="all">Tüm Depolar</option>';
    // Depo kodlarını sıralayarak listeleme (isteğe bağlı)
    const sortedRepos = Array.from(repositories).sort();
    sortedRepos.forEach(repo => {
        let option = document.createElement("option");
        option.value = repo;
        option.textContent = repoNames.get(repo) || "Bilinmiyor";
        repoFilterSelect.appendChild(option);
    });
}


function updateTable(filterType, repoFilter, searchQuery) {
    // Veriye artık window.pluginData.plugins üzerinden erişiyoruz
    if (!window.pluginData || !Array.isArray(window.pluginData.plugins)) {
         const tableBody = document.querySelector("#pluginTable tbody");
         tableBody.innerHTML = '<tr><td colspan="7">Eklenti verisi yüklenemedi veya formatı yanlış.</td></tr>';
         return; // Eğer veri yoksa, tabloyu boşalt ve dur
    }

    const tableBody = document.querySelector("#pluginTable tbody");
    tableBody.innerHTML = "";

    // CloudStream medya türlerini Türkçeleştirme tablosu
    const mediaTypeTranslations = {
        "podcast": "Podcast",
        "tvseries": "Dizi",
        "anime": "Anime",
        "ova": "OVA (Özel Video Animasyon)",
        "cartoon": "Çizgi Film",
        "documentary": "Belgesel",
        "short": "Kısa Film",
        "music": "Müzik",
        "live": "Canlı Yayın",
        "nsfw": "Yetişkin İçeriği",
        "others": "Diğer",
        "asiandrama": "Asya Dizisi",
        "animemovie": "Anime Filmi",
        "animeova": "Anime",
        "movie": "Film"
    };

    // Filtreleme ve arama işlemlerini window.pluginData.plugins üzerinde yapıyoruz
    window.pluginData.plugins.forEach(plugin => {
        // Hata düzeltildi: plugin.tvTypes'ın array olduğundan emin ol
        const pluginTvTypes = Array.isArray(plugin.tvTypes) ? plugin.tvTypes : [];
        // Hata düzeltildi: plugin.repoCodes'ın array olduğundan emin ol
        const pluginRepoCodes = Array.isArray(plugin.repoCodes) ? plugin.repoCodes : [];

        if (filterType !== "all" && !pluginTvTypes.includes(filterType)) return;
        if (repoFilter !== "all" && !pluginRepoCodes.includes(repoFilter)) return;
        if (searchQuery && !(plugin.name || "").toLowerCase().includes(searchQuery.toLowerCase())) return; // Eklenti adı olmayabilirse hata vermemesi için kontrol ekledik


        // Harf duyarlılığını kaldırarak medya türlerini Türkçeleştirelim
        const translatedTypes = pluginTvTypes.map(type => mediaTypeTranslations[type.toLowerCase()] || type).join(", ");

        // Repo kodlarını şık badge formatında gösterelim
        const repoBadges = pluginRepoCodes.map(repo => `<span class="repo-badge repo-${repo}">${repo}</span>`).join(" ");

        // Eğer eklenti NSFW ise ismi sansürle ve açıklamayı değiştir
        const isNSFW = pluginTvTypes.includes("NSFW");
        const pluginNameFormatted = isNSFW ? "****" : (plugin.name || "Ad Yok");
        const pluginDescriptionFormatted = isNSFW ? "Kullandığınız depo içerisinden kontrol ediniz" : (plugin.description || "Açıklama Yok");
        const pluginLanguageFormatted = plugin.language || "Bilinmiyor"; // Dil olmayabilirse

        const row = document.createElement("tr");
        row.innerHTML = `
            <td><img src="${(plugin.iconUrl || '').replace('%size%', '64')}" width="28" onerror="this.onerror=null; this.src='placeholder-icon.png';"></td> <!-- İkon URL'si olmayabilirse veya hata verirse placeholder ekledik -->
            <td class="bold">${pluginNameFormatted}</td>
            <td>${repoBadges}</td>
            <td>${translatedTypes}</td>
            <td class="desc">${pluginDescriptionFormatted}</td>
            <td>${pluginLanguageFormatted}</td>
            <td>${plugin.version || 'Bilinmiyor'}</td> <!-- Versiyon olmayabilirse -->
        `;
        tableBody.appendChild(row);
    });
}

        // Event Listener'ları ekleyelim (fetchPlugins tamamlandıktan sonra)
        // DOMContentLoaded yerine fetchPlugins içinde çağrılmaları daha güvenli
        // Çünkü event listener'lar window.pluginData yüklendikten sonra
        // updateTable/Stats/Filter fonksiyonlarını doğru şekilde tetiklemeli.

        document.getElementById("filterSelect").addEventListener("change", function() {
            const repoFilter = document.getElementById("repoFilterSelect").value;
            const searchQuery = document.getElementById("searchInput").value;
            updateTable(this.value, repoFilter, searchQuery);
             updateLastUpdated(); // Filtreleme değişince tarih sabit kalmalı, tekrar güncellemiyoruz
        });

        document.getElementById("repoFilterSelect").addEventListener("change", function() {
            const selectedRepo = this.value;
            updateStats(selectedRepo); // Sadece istatistikleri günceller
            const filterType = document.getElementById("filterSelect").value;
            const searchQuery = document.getElementById("searchInput").value;
            updateTable(filterType, selectedRepo, searchQuery); // Tabloyu günceller
            updateLastUpdated(); // Depo değişince tarih sabit kalmalı, tekrar güncellemiyoruz
        });


        document.getElementById("searchInput").addEventListener("input", function() {
            const filterType = document.getElementById("filterSelect").value;
            const repoFilter = document.getElementById("repoFilterSelect").value;
            updateTable(filterType, repoFilter, this.value);
             updateLastUpdated(); // Arama değişince tarih sabit kalmalı, tekrar güncellemiyoruz
        });

        document.getElementById("clearSearch").addEventListener("click", function() {
            document.getElementById("searchInput").value = "";
            const filterType = document.getElementById("filterSelect").value;
            const repoFilter = document.getElementById("repoFilterSelect").value;
            updateTable(filterType, repoFilter, "");
             updateLastUpdated(); // Arama temizlenince tarih sabit kalmalı, tekrar güncellemiyoruz
        });


        // Sayfa yüklendiğinde veriyi çek
        fetchPlugins();
        // updateLastUpdated(); // İlk çağrı fetchPlugins içinde yapılıyor

    </script>
</body>
</html>