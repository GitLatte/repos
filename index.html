<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CloudStream Eklenti Listesi</title>
    <style>
        body { 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    background-color: #f5f5f5; 
    text-align: center; 
}

.plugin-status-badge {
    display: inline-block;
    font-size: 10px;
    padding: 3px 6px;
    border-radius: 4px;
    margin-left: 5px;
    color: white;
    font-weight: bold;
    vertical-align: middle;
}

.new-plugin-badge {
    background-color: #28a745;
}

.updated-plugin-badge {
    background-color: #ffc107;
    color: #333;
}
h2 { color: #333; }

.stats { 
    font-size: 18px; 
    font-weight: bold; 
    margin-bottom: 10px; 
}

.filter-container { margin-bottom: 10px; }
select, input { 
    padding: 6px; 
    font-size: 14px; 
    border-radius: 4px; 
    border: 1px solid #ccc; 
    margin: 4px; 
}
button { 
    padding: 6px; 
    font-size: 14px; 
    border-radius: 4px; 
    background: #007BFF; 
    color: white; 
    border: none; 
    cursor: pointer; 
    transition: 0.3s ease; 
}
button:hover { background: #0056b3; }

table { 
    width: 95%; 
    border-collapse: separate; 
    border-spacing: 0; 
    margin: auto; 
    background: white; 
    border-radius: 10px; 
    overflow: hidden; 
    border: 2px solid #007BFF;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
}

th, td { 
    border: 1px solid #ccc; 
    padding: 10px; 
    text-align: left; 
    font-size: 14px; 
}
th { 
    background-color: #007BFF; 
    color: white; 
    font-size: 15px; 
    border-bottom: 2px solid #0056b3;
}
tr:hover { 
    background-color: #f9f9f9;
    transition: 0.2s ease-in-out;
}

.bold { font-weight: bold; }
.desc { font-size: 12px; color: #555; }

.repo-badge {
    display: inline-block;
    font-size: 12px;
    padding: 5px 8px;
    border-radius: 6px;
    margin-right: 4px;
    color: white;
    font-weight: bold;
    box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.2);
    cursor: pointer;
}

.repo-latte { background-color: #fe4d01; }
.repo-nikstream { background-color: #0077cc; }
.repo-feroxxcs3 { background-color: #d35400; }
.repo-makoto { background-color: #388e3c; }
.repo-kekikdevam { background-color: #512da8; }
.repo-kekikan { background-color: #c2185b; }
.repo-sarapcanagii { background-color: #455a64; }


.header-title {
    font-size: 28px;
    font-weight: bold;
    color: #007BFF;
    text-align: center;
    margin-bottom: 20px;
    text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.15);
}

.stats-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
}

.stats-card {
    background-color: #ffffff;
    padding: 12px 20px;
    border-radius: 8px;
    border: 2px solid #007BFF;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
    font-size: 16px;
    font-weight: bold;
    color: #333;
    min-width: 240px;
    text-align: center;
    transition: 0.3s ease-in-out;
}

.stats-card:hover {
    background-color: #007BFF;
    color: white;
    transform: scale(1.05);
}

th.sortable {
    cursor: pointer;
    position: relative;
    padding-right: 20px;
}

th.sortable::after {
    content: '⇅';
    position: absolute;
    right: 5px;
    opacity: 0.5;
}

th.sortable.asc::after {
    content: '↑';
    opacity: 1;
}

th.sortable.desc::after {
    content: '↓';
    opacity: 1;
}

.new-plugin-badge {
    background-color: #28a745;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 12px;
    margin-left: 8px;
    font-weight: bold;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.6; }
    100% { opacity: 1; }
}
    </style>
</head>
<body>
    <h2 class="header-title">CS TR Eklenti ve Depo Listesi</h2>

    <div class="stats-container">
        <div class="stats-card"><span id="totalPlugins">Toplam Eklenti: 0</span></div>
        <div class="stats-card"><span id="totalRepos">Toplam Depo: 0</span></div>
        <div class="stats-card"><span id="lastUpdated">Son Güncelleme: Bilinmiyor</span></div>
    </div>

    <div class="filter-container">
        <label for="filterSelect">Medya Türü Seç:</label>
        <select id="filterSelect">
            <option value="all">Tüm Eklentiler</option>
        </select>

        <label for="repoFilterSelect">Depo Seç:</label>
        <select id="repoFilterSelect">
            <option value="all">Tüm Depolar</option>
        </select>
    </div>

    <div class="filter-container">
        <input type="text" id="searchInput" placeholder="Eklenti Ara...">
        <button id="clearSearch">Temizle</button>
    </div>

    <table id="pluginTable">
        <thead>
            <tr>
                <th>İkon</th>
                <th class="sortable" data-sort="name">Ad</th>
                <th class="sortable" data-sort="repoCodesDisplay">Depo</th>
                <th class="sortable" data-sort="tvTypes">Tür</th>
                <th class="sortable" data-sort="description">Açıklama</th>
                <th class="sortable" data-sort="language">Dil</th>
                <th class="sortable" data-sort="version">Ver.</th>
                <th>Bulunduğu Depolar</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
    function fetchPlugins() {
        fetch("https://GitLatte.github.io/repos/data.json")
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP hatası: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            let pluginList = null;
            let lastUpdatedTimestamp = null;

            if (data && Array.isArray(data.plugins)) {
                pluginList = data.plugins;
                lastUpdatedTimestamp = data.timestamp;
            } else if (Array.isArray(data)) {
                pluginList = data;
                lastUpdatedTimestamp = null;
            } else {
                document.getElementById("totalPlugins").textContent = "Veri yüklenemedi.";
                document.getElementById("totalRepos").textContent = "";
                document.getElementById("lastUpdated").textContent = "Son Güncelleme: Hata";
                document.getElementById("filterSelect").innerHTML = '<option value="all">Veri Yok</option>';
                document.getElementById("repoFilterSelect").innerHTML = '<option value="all">Veri Yok</option>';
                document.querySelector("#pluginTable tbody").innerHTML = '<tr><td colspan="8">Eklenti verisi yüklenemedi veya formatı yanlış.</td></tr>';
                window.pluginData = { plugins: [], timestamp: null, pluginsByName: {} };
                return;
            }

            if (pluginList !== null) {
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                const pluginsByName = {};
                pluginList.forEach(plugin => {
                    plugin.repoCodesDisplay = (plugin.repoCodes && Array.isArray(plugin.repoCodes) && plugin.repoCodes.length > 0)
                        ? plugin.repoCodes
                        : ["Bilinmeyen Depo"];

                    const pluginName = plugin.name;
                    if (pluginName) {
                        if (!pluginsByName[pluginName]) {
                            pluginsByName[pluginName] = [];
                        }
                        pluginsByName[pluginName].push(plugin);
                    }

                    plugin.repoUpdated = {};
                    if (plugin.repoTimestamps) {
                        const now = new Date();
                        const RECENT_THRESHOLD_DAYS = 7;
                        const recentThresholdMs = RECENT_THRESHOLD_DAYS * 24 * 60 * 60 * 1000;

                        for (const repo in plugin.repoTimestamps) {
                            const ts = new Date(plugin.repoTimestamps[repo]);
                            plugin.repoUpdated[repo] = ((now - ts) < recentThresholdMs);
                        }
                    }
                });

                window.pluginData = {
                    plugins: pluginList,
                    timestamp: lastUpdatedTimestamp,
                    pluginsByName: pluginsByName
                };

                updateStats();
                updateFilterOptions();
                updateRepoOptions();
                updateTable("all", "all", "");
                updateLastUpdated();
            }
        })
        .catch(error => {
            console.error("JSON verisi yüklenemedi:", error);
            document.getElementById("totalPlugins").textContent = "Veri yüklenemedi.";
            document.getElementById("totalRepos").textContent = "";
            document.getElementById("lastUpdated").textContent = "Son Güncelleme: Hata";
            document.getElementById("filterSelect").innerHTML = '<option value="all">Veri Yok</option>';
            document.getElementById("repoFilterSelect").innerHTML = '<option value="all">Veri Yok</option>';
            document.querySelector("#pluginTable tbody").innerHTML = '<tr><td colspan="8">Eklenti verisi yüklenemedi veya formatı yanlış.</td></tr>';
            window.pluginData = { plugins: [], timestamp: null, pluginsByName: {} };
        });
    }

    function updateFilterOptions() {
        if (!window.pluginData || !Array.isArray(window.pluginData.plugins)) {
            document.getElementById("filterSelect").innerHTML = '<option value="all">Veri Yok</option>';
            return;
        }

        const mediaTypeTranslations = {
            "tvseries": "Dizi", "tv series": "Dizi", "tv-series": "Dizi", "series": "Dizi", "dizi": "Dizi",
            "anime": "Anime", "animeova": "Anime", "anime ova": "Anime", "anime-ova": "Anime",
            "movie": "Film", "film": "Film", "movies": "Film", "films": "Film",
            "animemovie": "Anime Filmi", "anime movie": "Anime Filmi", "anime-movie": "Anime Filmi",
            "asiandrama": "Asya Dizisi", "asian drama": "Asya Dizisi", "asian-drama": "Asya Dizisi",
            "podcast": "Podcast", "ova": "OVA (Özel Video Animasyon)", "cartoon": "Çizgi Film",
            "documentary": "Belgesel", "short": "Kısa Film", "music": "Müzik", "live": "Canlı Yayın",
            "nsfw": "Yetişkin İçeriği", "others": "Diğer"
        };

        const uniqueTypes = new Set();
        window.pluginData.plugins.forEach(plugin => {
            if (plugin.tvTypes) {
                plugin.tvTypes.forEach(type => {
                    const normalizedType = type.toLowerCase().trim();
                    const translatedType = mediaTypeTranslations[normalizedType];
                    if (translatedType) {
                        const mainType = Object.entries(mediaTypeTranslations).find(([_, value]) => value === translatedType)?.[0] || normalizedType;
                        uniqueTypes.add(mainType);
                    } else {
                        uniqueTypes.add(normalizedType);
                    }
                });
            }
        });

        const sortedTypes = Array.from(uniqueTypes).sort((a, b) => {
            const aText = mediaTypeTranslations[a] || a;
            const bText = mediaTypeTranslations[b] || b;
            return aText.localeCompare(bText, 'tr');
        });

        let options = '<option value="all">Tüm Eklentiler</option>';
        sortedTypes.forEach(type => {
            const displayText = mediaTypeTranslations[type] || type;
            options += `<option value="${type}">${displayText}</option>`;
        });

        document.getElementById("filterSelect").innerHTML = options;
    }

    function normalizeMediaType(type) {
        const normalized = type.toLowerCase().trim();
        if (normalized.includes('tv') && normalized.includes('series')) return 'tvseries';
        if (normalized.includes('anime') && normalized.includes('ova')) return 'animeova';
        if (normalized.includes('anime') && normalized.includes('movie')) return 'animemovie';
        if (normalized.includes('asian') && (normalized.includes('drama') || normalized.includes('dizi'))) return 'asiandrama';
        return normalized;
    }

    function updateRepoOptions() {
        if (!window.pluginData || !Array.isArray(window.pluginData.plugins)) {
            document.getElementById("repoFilterSelect").innerHTML = '<option value="all">Veri Yok</option>';
            return;
        }

        const repoCounts = {};
        window.pluginData.plugins.forEach(plugin => {
            if (plugin.repoCodesDisplay) {
                plugin.repoCodesDisplay.forEach(repo => {
                    repoCounts[repo] = (repoCounts[repo] || 0) + 1;
                });
            }
        });

        const uniqueRepos = Object.keys(repoCounts).sort();

        let options = '<option value="all">Tüm Depolar</option>';
        uniqueRepos.forEach(repo => {
             const displayRepoName = (repo === "Latte") ? "Latte/sinetech" : repo; // Latte istisnası gösterim
            options += `<option value="${repo}">${displayRepoName} (${repoCounts[repo]})</option>`;
        });

        document.getElementById("repoFilterSelect").innerHTML = options;
    }

    function updateStats() {
        if (!window.pluginData || !Array.isArray(window.pluginData.plugins)) {
            document.getElementById("totalPlugins").textContent = "Toplam Eklenti: 0";
            document.getElementById("totalRepos").textContent = "Toplam Depo: 0";
            return;
        }

        document.getElementById("totalPlugins").textContent =
            `Toplam Eklenti: ${window.pluginData.plugins.length}`;

        const uniqueReposInTotal = new Set();
        window.pluginData.plugins.forEach(plugin => {
            if (plugin.repoCodesDisplay) {
                plugin.repoCodesDisplay.forEach(repo => uniqueReposInTotal.add(repo));
            }
        });
        document.getElementById("totalRepos").textContent =
            `Toplam Depo: ${uniqueReposInTotal.size}`;
    }

    function updateLastUpdated() {
        if (!window.pluginData || !window.pluginData.timestamp) {
            document.getElementById("lastUpdated").textContent = "Son Güncelleme: Bilinmiyor";
            return;
        }

        const lastUpdate = new Date(window.pluginData.timestamp);
        const now = new Date();
        const diffInMinutes = Math.floor((now - lastUpdate) / (1000 * 60));

        let timeText;
        if (diffInMinutes < 1) {
            timeText = "az önce";
        } else if (diffInMinutes < 60) {
            timeText = `${diffInMinutes} dakika önce`;
        } else if (diffInMinutes < 1440) {
            const hours = Math.floor(diffInMinutes / 60);
            timeText = `${hours} saat önce`;
        } else {
            const days = Math.floor(diffInMinutes / 1440);
            timeText = `${days} gün önce`;
        }

        document.getElementById("lastUpdated").textContent = `Son Güncelleme: ${timeText}`;
    }

    let currentSort = {
        column: null,
        direction: 'asc'
    };

    function initSortableTable() {
        const headers = document.querySelectorAll('th.sortable');
        headers.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.sort;

                if (currentSort.column === column) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }

                headers.forEach(h => h.classList.remove('asc', 'desc'));
                header.classList.add(currentSort.direction);

                const filterType = document.getElementById('filterSelect').value;
                const repoFilter = document.getElementById('repoFilterSelect').value;
                const searchQuery = document.getElementById('searchInput').value;
                updateTable(filterType, repoFilter, searchQuery);
            });
        });
    }

    function updateTable(filterType, repoFilter, searchQuery) {
        if (!window.pluginData || !Array.isArray(window.pluginData.plugins)) {
            const tableBody = document.querySelector("#pluginTable tbody");
            tableBody.innerHTML = '<tr><td colspan="8">Eklenti verisi yüklenemedi veya formatı yanlış.</td></tr>';
            return;
        }

        const tableBody = document.querySelector("#pluginTable tbody");
        tableBody.innerHTML = "";

        const mediaTypeTranslations = {
            "podcast": "Podcast", "tvseries": "Dizi", "anime": "Anime", "ova": "OVA (Özel Video Animasyon)", "cartoon": "Çizgi Film", "documentary": "Belgesel", "short": "Kısa Film", "music": "Müzik", "live": "Canlı Yayın", "nsfw": "Yetişkin İçeriği", "others": "Diğer", "asiandrama": "Asya Dizisi", "animemovie": "Anime Filmi", "animeova": "Anime", "movie": "Film"
        };

        function sortPlugins(plugins) {
            return plugins.sort((a, b) => {
                // 1. isNew durumu true olanları her zaman en üste taşı
                if (a.isNew !== b.isNew) {
                    return b.isNew ? -1 : 1; // b.isNew true ise b daha önde (-1), a.isNew true ise a daha önde (1)
                }

                // 2. Eğer belirli bir sütun seçiliyse, o sütuna göre sırala
                if (currentSort.column) {
                    let aVal = a[currentSort.column];
                    let bVal = b[currentSort.column];

                    // repoCodesDisplay sütununda, repoCodesDisplay dizisini stringe çevirerek sırala
                    if (currentSort.column === 'repoCodesDisplay') {
                        aVal = (aVal || []).join(',');
                        bVal = (bVal || []).join(',');
                    }
                    // tvTypes sütununda, tvTypes dizisini stringe çevirerek sırala (çevirilerle)
                    else if (currentSort.column === 'tvTypes') {
                        const mediaTypeTranslations = { /* ... (çeviriler) ... */ };
                        aVal = aVal ? aVal.map(t => mediaTypeTranslations[t.toLowerCase()] || t).join(',') : '';
                        bVal = bVal ? bVal.map(t => mediaTypeTranslations[t.toLowerCase()] || t).join(',') : '';
                    }
                    // version sütununda sayısal sıralama yap
                    else if (currentSort.column === 'version') {
                        aVal = parseFloat(aVal) || 0;
                        bVal = parseFloat(bVal) || 0;
                         // Sayısal karşılaştırma
                        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                        return 0; // Eşitler
                    }
                    // name sütununda özel durum: ad aynı ise depoya göre sırala
                    else if (currentSort.column === 'name') {
                        const nameComparison = (aVal || '').localeCompare(bVal || '');
                        if (nameComparison !== 0) {
                            return currentSort.direction === 'asc' ? nameComparison : -nameComparison;
                        }
                        // İsimler aynıysa depo koduna göre sırala (gerçek kısa kod)
                        const aRepo = (a.repoCodesDisplay && a.repoCodesDisplay.length > 0) ? a.repoCodesDisplay[0] : '';
                        const bRepo = (b.repoCodesDisplay && b.repoCodesDisplay.length > 0) ? b.repoCodesDisplay[0] : '';
                        return currentSort.direction === 'asc' ? aRepo.localeCompare(bRepo) : -bRepo.localeCompare(aRepo);
                    }
                    // Diğer sütunlar için string karşılaştırma
                    else {
                         if (aVal === bVal) return 0;
                         const comparison = String(aVal || '').localeCompare(String(bVal || ''));
                         return currentSort.direction === 'asc' ? comparison : -comparison;
                    }

                    // Eğer spesifik sütun mantığı eşit döndürürse (name dışındaki sütunlarda)
                     if (aVal === bVal) {
                         // İkincil sıralama: Ada göre alfabetik, sonra depoya göre alfabetik
                         const nameComparison = (a.name || '').localeCompare(b.name || '');
                         if (nameComparison !== 0) {
                             return nameComparison; // İkincil olarak ada göre sırala
                         }
                         const aRepo = (a.repoCodesDisplay && a.repoCodesDisplay.length > 0) ? a.repoCodesDisplay[0] : '';
                         const bRepo = (b.repoCodesDisplay && b.repoCodesDisplay.length > 0) ? b.repoCodesDisplay[0] : '';
                         return aRepo.localeCompare(bRepo); // Üçüncül olarak depoya göre sırala
                     }
                      return 0; // Normal string karşılaştırması tamamlandıysa

                }

                // 3. Eğer hiçbir sütun seçili değilse (currentSort.column null), varsayılan sıralama:
                // Önce Ada göre alfabetik, sonra Depoya göre alfabetik.
                const nameComparison = (a.name || '').localeCompare(b.name || '');
                if (nameComparison !== 0) {
                    return nameComparison;
                }
                const aRepo = (a.repoCodesDisplay && a.repoCodesDisplay.length > 0) ? a.repoCodesDisplay[0] : '';
                const bRepo = (b.repoCodesDisplay && b.repoCodesDisplay.length > 0) ? b.repoCodesDisplay[0] : '';
                return aRepo.localeCompare(bRepo);
            });
        }


        let filteredPlugins = window.pluginData.plugins
            .filter(plugin => {
                if (filterType !== "all") {
                    if (!plugin.tvTypes) return false;
                    const normalizedFilterType = normalizeMediaType(filterType);
                    if (!plugin.tvTypes.some(type => normalizeMediaType(type) === normalizedFilterType)) return false;
                }

                if (repoFilter !== "all" && (!plugin.repoCodesDisplay || !plugin.repoCodesDisplay.includes(repoFilter))) return false;

                if (searchQuery && !plugin.name.toLowerCase().includes(searchQuery.toLowerCase())) return false;
                return true;
            });

        filteredPlugins = sortPlugins(filteredPlugins);

        filteredPlugins.forEach(plugin => {
            const row = document.createElement("tr");
            const iconCell = document.createElement("td");
            const nameCell = document.createElement("td");
            const repoCell = document.createElement("td");
            const typeCell = document.createElement("td");
            const descCell = document.createElement("td");
            const langCell = document.createElement("td");
            const verCell = document.createElement("td");
            const commonReposCell = document.createElement("td");

            const icon = document.createElement("img");
            icon.src = plugin.iconUrl ? plugin.iconUrl.replace("%size%", "32") : "";
            icon.width = 32;
            icon.height = 32;
            iconCell.appendChild(icon);

            nameCell.textContent = plugin.name;

            const RECENT_THRESHOLD_DAYS_FOR_BADGE = 7;
            const now = new Date();
            let showNewBadge = false;
            if (plugin.createdAt) {
                const createdAtDate = new Date(plugin.createdAt);
                if ((now - createdAtDate) < RECENT_THRESHOLD_DAYS_FOR_BADGE * 24 * 60 * 60 * 1000) {
                    showNewBadge = true;
                }
            }
            let showUpdatedBadge = false;
            if (plugin.repoTimestamps) {
                // repoUpdated alanındaki herhangi bir true değerini kontrol et
                if (Object.values(plugin.repoUpdated || {}).some(status => status === true)) {
                    showUpdatedBadge = true;
                }
            }


            if (showNewBadge) {
                const newBadge = document.createElement("span");
                newBadge.textContent = "Yeni";
                newBadge.className = "plugin-status-badge new-plugin-badge";
                nameCell.appendChild(newBadge);
            } else if (showUpdatedBadge) {
                const updatedBadge = document.createElement("span");
                updatedBadge.textContent = "Güncellendi";
                updatedBadge.className = "plugin-status-badge updated-plugin-badge";
                nameCell.appendChild(updatedBadge);
            }

            const isNSFW = plugin.tvTypes && plugin.tvTypes.some(type => type.toLowerCase() === 'nsfw');
            if (isNSFW) {
                icon.style.filter = 'blur(5px)';
                nameCell.style.filter = 'blur(5px)';
                descCell.style.filter = 'blur(5px)';

                [icon, nameCell, descCell].forEach(element => {
                    element.addEventListener('mouseover', () => element.style.filter = 'none');
                    element.addEventListener('mouseout', () => element.style.filter = 'blur(5px)');
                });
            }

            repoCell.innerHTML = (plugin.repoCodesDisplay || []).map(repo => {
                 let updatedIcon = "";
                 if (plugin.repoUpdated && plugin.repoUpdated[repo]) {
                     updatedIcon = '<span title="Bu depoda güncellendi" style="margin-left:4px;color:#28a745;font-weight:bold;">↻</span>';
                 }
                 const displayRepoName = (repo === "Latte") ? "Latte/sinetech" : repo; // Latte istisnası gösterim
                const cssSafeRepo = repo.toLowerCase().replace(/[^a-z0-9]/g, '');
                return `<span class="repo-badge repo-${cssSafeRepo}" data-repo="${repo}">${displayRepoName}${updatedIcon}</span>`;
            }).join(" ");

            repoCell.querySelectorAll('.repo-badge').forEach(badge => {
                badge.addEventListener('click', (event) => {
                    event.stopPropagation();
                    const selectedRepo = badge.dataset.repo;
                    document.getElementById('repoFilterSelect').value = selectedRepo;
                    const filterType = document.getElementById('filterSelect').value;
                    const searchQuery = document.getElementById('searchInput').value;
                    updateTable(filterType, selectedRepo, searchQuery);
                    updateStats();
                });
            });


            typeCell.textContent = (plugin.tvTypes || []).map(type =>
                mediaTypeTranslations[type.toLowerCase()] || type
            ).join(", ");

            descCell.textContent = plugin.description || "";
            langCell.textContent = plugin.language || "";
            verCell.textContent = plugin.version || "";

            // Ortak eklentileri isme göre bul ve görüntüle
            const pluginsWithSameName = window.pluginData.pluginsByName[plugin.name] || [];
            if (pluginsWithSameName.length > 1) {
                const commonRepos = pluginsWithSameName
                    .filter(p => p !== plugin) // Kendisini hariç tut
                    .flatMap(p => p.repoCodesDisplay || []); // Diğer kopyaların depolarını topla

                const uniqueCommonRepos = Array.from(new Set(commonRepos)); // Tekrarları kaldır

                if (uniqueCommonRepos.length > 0) {
                     commonReposCell.innerHTML = uniqueCommonRepos.map(repo => {
                         let updatedIcon = "";
                         // Ortak eklentilerdeki repo için güncelleme simgesi (O repodaki kopyayı bulup updated durumunu kontrol et)
                         const commonPluginInRepo = pluginsWithSameName.find(p => p.repoCodesDisplay && p.repoCodesDisplay.includes(repo));
                         if (commonPluginInRepo && commonPluginInRepo.repoUpdated && commonPluginInRepo.repoUpdated[repo]) {
                             updatedIcon = '<span title="Bu depoda güncellendi" style="margin-left:4px;color:#28a745;font-weight:bold;">↻</span>';
                         }

                         const displayRepoName = (repo === "Latte") ? "Latte/sinetech" : repo; // Latte istisnası gösterim
                         const cssSafeRepo = repo.toLowerCase().replace(/[^a-z0-9]/g, '');
                         return `<span class="repo-badge repo-${cssSafeRepo}" data-repo="${repo}" title="Bu eklentinin ${displayRepoName} deposundaki versiyonunu göster">${displayRepoName}${updatedIcon}</span>`;
                     }).join(" ");

                     // Ortak depo badge'lerine tıklama olayı ekle
                     commonReposCell.querySelectorAll('.repo-badge').forEach(badge => {
                         badge.addEventListener('click', (event) => {
                             event.stopPropagation();
                             const selectedRepo = badge.dataset.repo;
                             document.getElementById('repoFilterSelect').value = selectedRepo;
                             const filterType = document.getElementById('filterSelect').value;
                             const searchQuery = document.getElementById('searchInput').value;
                             updateTable(filterType, selectedRepo, searchQuery);
                             updateStats();
                         });
                     });

                } else {
                    // Aynı isimde başka eklenti var ama repo kodu yoksa
                     commonReposCell.textContent = "Ortak değil";
                }
            } else {
                 // Aynı isimde başka eklenti yoksa (Tek Depo veya sadece o isimden bir tane var)
                 if (plugin.repoCodesDisplay && plugin.repoCodesDisplay.length === 1 && plugin.repoCodesDisplay[0] !== "Bilinmeyen Depo") {
                      const repo = plugin.repoCodesDisplay[0];
                      const displayRepoName = (repo === "Latte") ? "Latte/sinetech" : repo; // Latte istisnası gösterim
                      const cssSafeRepo = repo.toLowerCase().replace(/[^a-z0-9]/g, '');
                      commonReposCell.innerHTML = `Sadece <span class="repo-badge repo-${cssSafeRepo}" data-repo="${repo}">${displayRepoName}</span>`;

                      commonReposCell.querySelectorAll('.repo-badge').forEach(badge => {
                         badge.addEventListener('click', (event) => {
                             event.stopPropagation();
                             const selectedRepo = badge.dataset.repo;
                             document.getElementById('repoFilterSelect').value = selectedRepo;
                             const filterType = document.getElementById('filterSelect').value;
                             const searchQuery = document.getElementById('searchInput').value;
                             updateTable(filterType, selectedRepo, searchQuery);
                             updateStats();
                         });
                     });

                 } else {
                      commonReposCell.textContent = "Tek Depo"; // Belki repoCodesDisplay "Bilinmeyen Depo" veya birden fazla (ama ortak değil)
                 }
            }


            row.appendChild(iconCell);
            row.appendChild(nameCell);
            row.appendChild(repoCell);
            row.appendChild(typeCell);
            row.appendChild(descCell);
            row.appendChild(langCell);
            row.appendChild(verCell);
            row.appendChild(commonReposCell);

            tableBody.appendChild(row);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchPlugins();
        initSortableTable();

        document.getElementById('filterSelect').addEventListener('change', () => {
            const filterType = document.getElementById('filterSelect').value;
            const repoFilter = document.getElementById('repoFilterSelect').value;
            const searchQuery = document.getElementById('searchInput').value;
            updateTable(filterType, repoFilter, searchQuery);
        });

        document.getElementById('repoFilterSelect').addEventListener('change', () => {
            const filterType = document.getElementById('filterSelect').value;
            const repoFilter = document.getElementById('repoFilterSelect').value;
            const searchQuery = document.getElementById('searchInput').value;
            updateTable(filterType, repoFilter, searchQuery);
            updateStats();
        });

        document.getElementById('searchInput').addEventListener('input', () => {
            const filterType = document.getElementById('filterSelect').value;
            const repoFilter = document.getElementById('repoFilterSelect').value;
            const searchQuery = document.getElementById('searchInput').value;
            updateTable(filterType, repoFilter, searchQuery);
        });

         document.getElementById("clearSearch").addEventListener("click", function() {
            document.getElementById("searchInput").value = "";
            const filterType = document.getElementById("filterSelect").value;
            const repoFilter = document.getElementById("repoFilterSelect").value;
            updateTable(filterType, repoFilter, "");
        });
    });
    </script>
</body>
</html>